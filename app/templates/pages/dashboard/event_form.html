{% extends "layouts/dashboard_layout.html" %}

{% block title %}Tạo sự kiện mới{% endblock %}

{% block content %}


<div class="event_form">
    <div class="event_form-actions">
        <button type="submit" form="eventForm" class="create" form="eventForm">
            <div data-lucide="save"></div>
        </button>
    </div>
    <form method="POST" action="{{ request.path }}" id="eventForm" enctype="multipart/form-data">
        <div class="event_form-container">
            <div class="event_form-main">
                <div class="is-created">
                    {% if event_id %}
                    <span class="status">CREATED</span>
                    {% endif %}
                </div>
                <div class="title">
                    <h3>Tạo nội dung sự kiện</h3>
                    <p> Vui lòng nhập mô tả chi tiết về sự kiện (nội dung, khách mời, giá trị mang lại...). </p>
                    <p>Nội dung này sẽ hiển thị trong trang sự kiện công khai.</p>
                </div>
                <div class="form-data">
                    <div class="input-field">
                        <p>Hình ảnh</p>

                        <div class="image-container">
                            <img src="{{ event.images if event and event.images else '' }}" id="preview" />
                            <button type="button" class="img-delete">
                                <div data-lucide="x"></div>
                            </button>
                        </div>
                        <input name="images" value="{{ event.images if event else '' }}" style="display: none;" />
                        <input type="file" name="images" id="img"
                            value="{{ event.images if event and event.images else '' }}" />
                    </div>

                    <div class="input-field">
                        <p>Tên sự kiện</p>
                        <input type="text" name="title" id="title" value="{{ event.title if event else '' }}"
                            class="{% if 'title' in missing_fields %}is-invalid{% endif %}" />
                    </div>

                    <div class="input-field">
                        <p>Tên định danh</p>
                        <input type="text" name="alias" id="alias" readonly
                            value="{{ event.alias if event else '' }}" />
                    </div>

                    <div class="input-group">
                        <div class="input-field">
                            <p>Thời gian tổ chức</p>
                            <div class="group" style="display: flex; flex-grow: 1; gap: 10px;">
                                <input type="date" name="start_date" placeholder="Chọn ngày tổ chức"
                                    value="{{ event.start_date if event else '' }}"
                                    class="{% if 'start_date' in missing_fields %}is-invalid{% endif %}" />
                                <input type="time" name="start_time" placeholder="Giờ bắt đầu"
                                    value="{{ event.start_time if event else '' }}"
                                    class="{% if 'start_time' in missing_fields %}is-invalid{% endif %}" />
                            </div>
                        </div>
                        <div class="input-field">
                            <p>Thời gian kết thúc</p>
                            <div style="display: flex; gap: 20px;">
                                <div class="group" style="display: flex; flex-grow: 1; gap: 10px;">
                                    <input type="date" name="end_date" placeholder="Chọn ngày tổ chức"
                                        value="{{ event.end_date if event else '' }}"
                                        class="{% if 'end_date' in missing_fields %}is-invalid{% endif %}" />
                                    <input type="time" name="end_time" placeholder="Giờ kết thúc"
                                        value="{{ event.end_time if event else '' }}"
                                        class="{% if 'end_time' in missing_fields %}is-invalid{% endif %}" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="input-field">
                            <p>Địa điểm tổ chức (Tòa nhà, sân vận động ...)</p>
                            <input type="text" name="venue" placeholder="Địa điểm tổ chức sự kiện"
                                value="{{ event.venue if event else '' }}"
                                class="{% if 'venue' in missing_fields %}is-invalid{% endif %}" />
                        </div>
                        <div class="input-field">
                            <p>Địa chỉ cụ thể</p>
                            <input type="text" name="location" placeholder="Địa chỉ cụ thể ( tên đường, thành phố )"
                                value="{{ event.location if event else '' }}"
                                class="{% if 'location' in missing_fields %}is-invalid{% endif %}" />
                        </div>
                    </div>

                    <div class="input-field">
                        <p>Mô tả sự kiện</p>

                        {{ ckeditor.create(value=event['description'] if event and event.get('description') else
                        '') }}
                    </div>

                    <div class="event_form-actions">
                        <button type="submit" class="create">
                            <div data-lucide="save"></div>
                        </button>
                    </div>
                </div>
            </div>
            <div class="event_form-ticket">
                <div class="title">
                    <h3>Cấu hình vé tham dự</h3>
                    <p>Thêm các khu vực tổ chứ và loại vé tham dự</p>
                    <p>Nội dung này sẽ hiển thị trong trang sự kiện công khai.</p>
                </div>
                <div class="form-data">
                    <div class="input-field">
                        <div class="label">
                            <p>Cấu hình khu vực tổ chức</p>
                            <button type="button" class="create" id="add-zone" onclick="addZone()">Thêm khu vực</button>
                        </div>

                        <div class="zone-setup">
                            <div class="zone-container">


                            </div>
                            <input type="hidden" name="zones" id="zones-data" />


                            <div class="zone-card" id="zone-card">
                                <div class="label">
                                    <p>Thông tin khu vực</p>
                                    <div class="label-actions">
                                        <button type="button" class="delete" onclick="deleteZone()">Xóa</button>
                                        <button type="button" class="create">Lưu</button>
                                    </div>
                                </div>

                                <div class="input-field">
                                    <p>Tên khu vực tổ chức</p>
                                    <input type="text" id="zone-name" placeholder="Khu vực A, khu vực thường ...."
                                        onchange="updateCurrentZone()" />
                                </div>

                                <div class="input-group">
                                    <div class="input-field flex-66">
                                        <p>Thể loại</p>
                                        <select id="zone-type" onchange="updateCurrentZone()">
                                            <option value="floor">Ghế ngồi</option>
                                            <option value="balcony">Tự do</option>
                                        </select>
                                    </div>
                                    <div class="input-field" onchange="updateCurrentZone()">
                                        <p>Sức chứa</p>
                                        <input type="number" id="zone-capacity" min="0" />
                                    </div>
                                </div>

                                <div class="input-field" onchange="updateCurrentZone()">
                                    <p>Mô tả</p>
                                    <input type="text" id="zone-description"
                                        placeholder="Mô tả khu vực: vị trí, hướng dẫn..." />
                                </div>

                                <div class="input-field">
                                    <p>Cấu hình vé </p>
                                    <button type="button" id="add-ticket" class="create">Thêm loại vé</button>
                                    <ul id="ticket-list"></ul>
                                </div>
                            </div>

                            <div class="ticket-type">
                                <div class="label">
                                    <p>Thông tin loại vé</p>
                                    <div class="label-actions">
                                        <button type="button" class="delete">Xóa</button>
                                        <button type="button" class="create">Tạo vé</button>
                                    </div>

                                </div>
                                <div class="input-field">
                                    <p>Tên, loại vé</p>
                                    <input type="text" name="title" id="title" placeholder="Vé vip, vé thường ..." />
                                </div>
                                <div class="input-group">
                                    <div class="input-field flex-66 ">
                                        <p>Giá vé</p>
                                        <input type="number" name="venue" placeholder="Giá vé" min="0" />
                                    </div>
                                    <div class="input-field">
                                        <p>Số lượng</p>
                                        <input type="number" name="location" placeholder="số lượng" min="0" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    const input = document.getElementById("img");
    const preview = document.getElementById("preview");
    const deleteBtn = document.querySelector(".img-delete");
    const title = document.getElementById("title");
    const alias = document.getElementById("alias");
    const defaultImg = document.getElementById("default-img");
    var event_id = '{{ event_id }}';
    var event = '{{ event }}';

    // Zone Actions
    const zoneContainer = document.querySelector(".zone-container");
    const addZoneBtn = document.getElementById("add-zone");
    const zonesInput = document.getElementById("zones-data");
    let currentCharCode = "A".charCodeAt(0);
    let zoneCount = 0;
    let zones = '{{ zones|default([])|tojson }}' && event_id ? JSON.parse('{{ zones|default([])|tojson }}') : [];
    let currentZoneIndex = null; // zone đang chọn

    function syncZoneNaming(zones) {
        if (!zones || zones.length === 0) return;

        const lastZone = zones[zones.length - 1];
        const match = lastZone.name.match(/Zone\s+([A-Z])(\d+)?$/i);

        if (match) {
            const charPart = match[1].toUpperCase();
            const numberPart = match[2] ? parseInt(match[2]) : null;

            currentCharCode = charPart.charCodeAt(0);
            if (numberPart) {
                zoneCount = numberPart; // nếu là Z1, Z2...
            }
        }
    }

    function getNextZoneName() {
        if (currentCharCode < "Z".charCodeAt(0)) {
            currentCharCode++;
            return "Zone " + String.fromCharCode(currentCharCode);
        } else {
            zoneCount++;
            return "Zone Z" + zoneCount;
        }
    }

    function addZone() {
        syncZoneNaming(zones)
        const zoneName = getNextZoneName();

        // Thêm vào mảng
        zones.push({
            name: zoneName,
            type: "STAND",
            capacity: 100,
            description: "",
        });

        // render ra giao diện
        const zoneItem = document.createElement("div");
        zoneItem.className = "zone-item";
        zoneItem.textContent = zoneName;
        zoneContainer.appendChild(zoneItem);

        // update hidden input
        zonesInput.value = JSON.stringify(zones);

        zoneRender();
    }

    function selectZone(zoneIndex) {
        console.log("Selecting zone at index:", zoneIndex, zones[zoneIndex]);
        const zone = zones[zoneIndex];
        if (!zone) {
            console.error("Zone not found with id:", zones[zoneIndex]);
            return;
        }

        currentZoneIndex = zoneIndex;

        const zoneNameInput = document.getElementById("zone-name");
        const zoneTypeSelect = document.getElementById("zone-type");
        const zoneCapacityInput = document.getElementById("zone-capacity");
        const zoneDescriptionInput = document.getElementById("zone-description");
        // const zoneTicketList = document.getElementById("ticket-list");

        zoneNameInput.value = zone.name || "";
        zoneTypeSelect.value = zone.type || "balcony";
        zoneCapacityInput.value = zone.capacity || 100;
        zoneDescriptionInput.value = zone.description || "";

        zoneRender();
        syncZoneNaming(zones);
        // Nếu cần load vé của zone
        // renderTickets(zone.tickets || []);

        zoneRender();
        syncZoneNaming(zones);

    }

    function zoneRender() {
        zoneContainer.innerHTML = "";
        zones.map((zone, index) => {
            const zoneElem = document.createElement("div");
            zoneElem.className = "zone-item " + (currentZoneIndex === index ? "active" : "");

            // Gắn event listener đúng zone
            zoneElem.addEventListener("click", () => selectZone(index));

            zoneElem.textContent = zone.name;
            zoneContainer.appendChild(zoneElem);
        });
    }

    function deleteZone() {
        // Kiểm tra mảng zones có rỗng không
        if (zones.length === 0 || currentZoneIndex < 0 || currentZoneIndex >= zones.length) {
            console.error("No zone selected or zones empty");
            return;
        }

        // Hỏi xác nhận trước khi xóa
        const zoneName = zones[currentZoneIndex].name || `Zone ${currentZoneIndex + 1}`;
        if (!confirm(`Bạn có chắc chắn muốn xóa ${zoneName}?`)) {
            return; // Hủy xóa nếu người dùng nhấn Cancel
        }

        // Xóa zone hiện tại theo index
        zones.splice(currentZoneIndex, 1);

        // Điều chỉnh currentZoneIndex sau khi xóa
        if (currentZoneIndex >= zones.length) {
            currentZoneIndex = zones.length - 1; // chọn zone cuối cùng còn lại
        }

        // Cập nhật UI
        if (currentZoneIndex >= 0) {
            selectZone(currentZoneIndex);
        }
        zoneRender();
        syncZoneNaming(zones);
    }

    function updateCurrentZone() {
        // Kiểm tra có zone nào đang được chọn không
        if (currentZoneIndex < 0 || currentZoneIndex >= zones.length) {
            console.error("No zone selected");
            return;
        }



        const zone = zones[currentZoneIndex];

        // Lấy giá trị từ form
        const zoneNameInput = document.getElementById("zone-name");
        const zoneTypeSelect = document.getElementById("zone-type");
        const zoneCapacityInput = document.getElementById("zone-capacity");
        const zoneDescriptionInput = document.getElementById("zone-description");

        // Cập nhật dữ liệu zone
        zone.name = zoneNameInput.value || zone.name;
        zone.type = zoneTypeSelect.value || zone.type;
        zone.capacity = parseInt(zoneCapacityInput.value) || zone.capacity;
        zone.description = zoneDescriptionInput.value || zone.description;

        // Cập nhật UI nếu cần (tên zone trong danh sách)
        const zoneElement = document.querySelector(`.zone-item.active`);
        if (zoneElement) {
            zoneElement.textContent = zone.name;
        }
        console.log("Updating zone:", zone);
        // Đồng bộ với input hidden hoặc lưu dữ liệu
        zonesInput.value = JSON.stringify(zones);

        // Nếu cần, cập nhật tickets hoặc tên zone đồng bộ
        zoneRender();
        syncZoneNaming(zones);
    }

    zoneRender();



    // Hàm tạo slug
    const slugify = text => text
        .replace(/đ/g, "d").replace(/Đ/g, "d")           // thay "đ"
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")// bỏ dấu
        .replace(/[^\w\s-]/g, "")                        // bỏ ký tự đặc biệt
        .trim().toLowerCase()
        .replace(/[\s_-]+/g, "-");                       // space/underscore => "-"

    // Cập nhật alias theo title
    title?.addEventListener("input", e => {
        alias.value = slugify(e.target.value);
    });

    // Khi chọn ảnh
    input.addEventListener("change", e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = ev => {
            preview.src = ev.target.result;
            preview.style.display = "block";
            defaultImg.style.display = "none";   // ẩn logo mặc định
            deleteBtn.style.display = "inline-block";

        };
        reader.readAsDataURL(file);
    });

    // Xóa ảnh => ẩn ảnh + ẩn nút
    deleteBtn.addEventListener("click", () => {
        preview.src = "";
        input.value = "";
        deleteBtn.classList.remove("has-image");
    });
</script>

{% endblock %}